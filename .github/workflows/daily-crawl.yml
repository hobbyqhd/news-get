name: Daily News Crawl

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8:00 UTC (åŒ—äº¬æ—¶é—´ 16:00)
    - cron: '0 8 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create data directories
      run: |
        mkdir -p data/logs
        mkdir -p data/news
        mkdir -p data/reports
        mkdir -p data/archives
        mkdir -p data/images
        
    - name: Run daily crawl
      run: python scripts/daily_crawl.py
      
    - name: Get current date
      run: |
        echo "CURRENT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      
    - name: Prepare email body with MD content
      run: |
        if [ -f data/new_files.txt ] && [ -s data/new_files.txt ]; then
          # åˆ›å»ºä¸´æ—¶ HTML æ–‡ä»¶å­˜å‚¨é‚®ä»¶å†…å®¹
          cat > /tmp/email_body.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; }
              .container { max-width: 800px; margin: 0 auto; }
              .header { color: #333; margin-bottom: 20px; }
              .news-item { background: #f5f5f5; padding: 15px; margin: 15px 0; border-left: 4px solid #007bff; }
              .news-date { color: #007bff; font-weight: bold; margin-bottom: 10px; }
              .news-content { color: #333; white-space: pre-wrap; word-wrap: break-word; font-size: 14px; }
              .footer { margin-top: 30px; color: #666; font-size: 12px; }
            </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h2>ğŸ“° æ¯æ—¥æ–°é—»æ›´æ–°</h2>
              <p>äº²çˆ±çš„ç”¨æˆ·ï¼Œ</p>
              <p>ä»¥ä¸‹æ˜¯ä»Šæ—¥æ–°ç”Ÿæˆçš„æ–°é—»å†…å®¹ï¼ˆä»…åŒ…å«æœ¬æ¬¡æ–°å¢æ–‡æ¡£ï¼‰ï¼š</p>
            </div>
        EOF
          
          # é€ä¸ªè¯»å– new_files.txt ä¸­çš„æ–‡ä»¶ï¼Œå°†å†…å®¹è¿½åŠ åˆ° HTML
          cat data/new_files.txt | while read file; do
            if [ -f "$file" ]; then
              # æå–æ—¥æœŸä½œä¸ºæ ‡é¢˜
              date_part=$(basename "$file" .md)
              echo "    <div class=\"news-item\">" >> /tmp/email_body.html
              echo "      <div class=\"news-date\">ğŸ“… $date_part</div>" >> /tmp/email_body.html
              echo "      <div class=\"news-content\">" >> /tmp/email_body.html
              # è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè¿›è¡Œ HTML è½¬ä¹‰
              cat "$file" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' >> /tmp/email_body.html
              echo "      </div>" >> /tmp/email_body.html
              echo "    </div>" >> /tmp/email_body.html
            fi
          done
          
          # æ·»åŠ é¡µè„š
          cat >> /tmp/email_body.html << 'EOF'
            <div class="footer">
              <p>ç¥å¥½ï¼<br>GitHub Actions è‡ªåŠ¨åŒ–çˆ¬è™«</p>
            </div>
          </div>
        </body>
        </html>
        EOF
          
          # å°†å†…å®¹è½¬æ¢ä¸ºç¯ä¿çš„ç¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨ EOF åˆ†éš”ï¼‰
          EMAIL_BODY=$(cat /tmp/email_body.html)
          echo "EMAIL_BODY<<EOF" >> $GITHUB_ENV
          echo "$EMAIL_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "âœ“ Email body prepared with MD content"
        else
          echo "No new files found"
          echo "EMAIL_BODY=<p>ä»Šæ—¥æœªæ–°å¢æ–°é—»å†…å®¹ã€‚</p>" >> $GITHUB_ENV
        fi
      
    - name: Send email with news
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.GMAIL_USERNAME }}
        password: ${{ secrets.GMAIL_APP_PASSWORD }}
        subject: "æ¯æ—¥æ–°é—»æ›´æ–° - ${{ env.CURRENT_DATE }}"
        html_body: ${{ env.EMAIL_BODY }}
        to: liubingxin1030@outlook.com
        from: ${{ secrets.GMAIL_USERNAME }}
        secure: false
        encryption: tls