name: Daily News Crawler

on:
  schedule:
    # 每天北京时间早上 8:30 (UTC+8 = UTC 00:30)
    - cron: '30 0 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  daily-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许提交代码
    env:
      TZ: Asia/Shanghai
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: requirements.txt
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Create necessary directories
        run: |
          mkdir -p data/logs data/reports data/news data/archives data/images
          
      - name: Run Daily News Crawler
        run: |
          python scripts/daily_crawl.py
      
      - name: Check if new files exist
        id: check_files
        run: |
          if [ -f data/new_files.txt ] && [ -s data/new_files.txt ]; then
            echo "has_new_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_new_files=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Get current date
        if: steps.check_files.outputs.has_new_files == 'true'
        run: |
          BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
          echo "CURRENT_DATE=$BEIJING_TIME" >> $GITHUB_ENV
      
      - name: Prepare email body with MD content
        if: steps.check_files.outputs.has_new_files == 'true'
        run: python3 scripts/format_email.py
      
      - name: Send email with news
        if: steps.check_files.outputs.has_new_files == 'true' && success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "每日新闻更新 - ${{ env.CURRENT_DATE }}"
          html_body: ${{ env.EMAIL_BODY }}
          to: liubingxin1030@outlook.com
          from: ${{ secrets.GMAIL_USERNAME }}
          secure: false
          encryption: tls
          
      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/news/ data/reports/ || true
          git diff --staged --quiet || git commit -m "chore: 自动更新每日新闻 [$(date +'%Y-%m-%d')]"
          git push
