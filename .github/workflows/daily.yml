name: Daily News Crawler

on:
  schedule:
    # 每天北京时间早上 7:00 (UTC+8 = UTC 23:00)
    - cron: '0 23 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  daily-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许提交代码
    env:
      TZ: Asia/Shanghai
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: requirements.txt
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Create necessary directories
        run: |
          mkdir -p data/logs data/reports data/news data/archives data/images
          
      - name: Run Daily News Crawler
        run: |
          python scripts/daily_crawl.py
          
      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/news/ data/reports/ || true
          git diff --staged --quiet || git commit -m "chore: 自动更新每日新闻 [$(date +'%Y-%m-%d')]"
          git push
